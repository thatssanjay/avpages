<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Idea Preferences</title>
    <!-- Bootstrap 4 CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            margin-top: 30px;
            margin-bottom: 30px;
        }
        table {
            width: 80%;
            margin: 0 auto;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .editable-cell {
            cursor: pointer;
        }
        .dropdown {
            min-width: 150px;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- CSV Upload Section -->
    <h2 class="text-center">Upload Team Idea Preferences</h2>
    <div class="form-group">
        <label for="csvUpload">Choose CSV File</label>
        <input type="file" class="form-control-file" id="csvUpload" accept=".csv">
    </div>
    <button class="btn btn-primary" id="processCsvBtn">Process CSV</button>

    <!-- Data Table Display -->
    <h2 class="text-center" id="tableTitle" style="display:none;">Data Table</h2>
    <table class="table table-striped table-bordered" id="dataTable" style="display:none;">
        <thead>
            <tr>
                <th>Id</th>
                <th>Team Name</th>
                <th>#Preference 1</th>
                <th>#Preference 2</th>
                <th>#Preference 3</th>
                <th>Completion time</th>
            </tr>
        </thead>
        <tbody id="dataTableBody"></tbody>
    </table>

    <!-- Team Idea Mapping (Editable) -->
    <h2 class="text-center" id="mappingTitle" style="display:none;">Team Idea Mapping</h2>
    <table class="table table-striped table-bordered" id="teamIdeaMapping" style="display:none;">
        <thead>
            <tr>
                <th>Team Name</th>
                <th>Idea</th>
            </tr>
        </thead>
        <tbody id="teamIdeaMappingBody"></tbody>
    </table>

    <div class="button-container">
        <button class="btn btn-success" id="exportToExcel" style="display:none;">Export to Excel</button>
    </div>
</div>

<!-- Bootstrap 4 JS and additional dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
    // Helper function to download CSV files
    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) { // Feature detection for browser support
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
        }
    }

    // Parse the CSV and process the data
    document.getElementById('processCsvBtn').addEventListener('click', function () {
        const fileInput = document.getElementById('csvUpload');
        const file = fileInput.files[0];
        if (!file) {
            alert('Please upload a CSV file.');
            return;
        }

        Papa.parse(file, {
            complete: function (results) {
                const data = results.data;
                const headers = results.meta.fields;  // Use results.meta.fields to get the header row as an array.
                
                const requiredColumns = ['Id', 'Start time', 'Completion time', 'Email', 'Name', 'Select your Team', 'Select Idea by order of preference (Preference 1)', 'Select Idea by order of preference (Preference 1)1', 'Select Idea by order of preference (Preference 3)'];

                // Check if all required columns are present
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                if (missingColumns.length > 0) {
                    alert('Missing columns: ' + missingColumns.join(', '));
                    return;
                }

                // Rename columns as per requirements
                const renamedData = data.slice(1).map(row => {
                    return {
                        id: row[headers.indexOf('Id')],
                        teamName: row[headers.indexOf('Select your Team')],
                        preference1: row[headers.indexOf('Select Idea by order of preference (Preference 1)')],
                        preference2: row[headers.indexOf('Select Idea by order of preference (Preference 1)1')],
                        preference3: row[headers.indexOf('Select Idea by order of preference (Preference 3)')],
                        completionTime: row[headers.indexOf('Completion time')],
                    };
                });

                // Sort by Completion time ascending
                renamedData.sort((a, b) => new Date(a.completionTime) - new Date(b.completionTime));

                // Show data table
                document.getElementById('tableTitle').style.display = 'block';
                const dataTableBody = document.getElementById('dataTableBody');
                dataTableBody.innerHTML = '';
                renamedData.forEach((row) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td>${row.teamName}</td>
                        <td>${row.preference1}</td>
                        <td>${row.preference2}</td>
                        <td>${row.preference3}</td>
                        <td>${row.completionTime}</td>
                    `;
                    dataTableBody.appendChild(tr);
                });
                document.getElementById('dataTable').style.display = 'table';

                // Allocate ideas to teams based on preferences and Completion time
                const teamIdeaMapping = [];
                const ideaAllocation = {};
                renamedData.forEach(row => {
                    const preferences = [row.preference1, row.preference2, row.preference3];
                    preferences.forEach(pref => {
                        if (!ideaAllocation[pref]) ideaAllocation[pref] = [];
                        if (ideaAllocation[pref].length < 2) {
                            teamIdeaMapping.push({ teamName: row.teamName, idea: pref });
                            ideaAllocation[pref].push(row.teamName);
                        }
                    });
                });

                // Display team idea mapping
                document.getElementById('mappingTitle').style.display = 'block';
                const mappingBody = document.getElementById('teamIdeaMappingBody');
                mappingBody.innerHTML = '';
                teamIdeaMapping.forEach((mapping, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="editable-cell" data-index="${index}" data-type="idea">${mapping.teamName}</td>
                        <td class="editable-cell" data-index="${index}" data-type="idea">${mapping.idea}</td>
                    `;
                    mappingBody.appendChild(tr);
                });
                document.getElementById('teamIdeaMapping').style.display = 'table';

                // Add event listeners for editable cells (team-idea mappings)
                document.querySelectorAll('.editable-cell').forEach(cell => {
                    cell.addEventListener('click', function () {
                        const currentValue = this.textContent;
                        const index = this.dataset.index;
                        const type = this.dataset.type;

                        // Create dropdown for selecting a new idea
                        const allIdeas = Object.keys(ideaAllocation);
                        const dropdown = document.createElement('select');
                        dropdown.classList.add('form-control', 'dropdown');
                        allIdeas.forEach(idea => {
                            const option = document.createElement('option');
                            option.value = idea;
                            option.textContent = idea;
                            if (idea === currentValue) option.selected = true;
                            dropdown.appendChild(option);
                        });

                        // Replace the cell with the dropdown
                        this.innerHTML = '';
                        this.appendChild(dropdown);

                        // Add event to save selection
                        dropdown.addEventListener('change', function () {
                            const selectedValue = this.value;

                            // Update the mapping data
                            teamIdeaMapping[index][type] = selectedValue;

                            // Replace dropdown with the label after selection
                            const label = document.createElement('span');
                            label.textContent = selectedValue;
                            cell.innerHTML = '';
                            cell.appendChild(label);
                        });
                    });
                });

                // Enable export to Excel
                document.getElementById('exportToExcel').style.display = 'block';
                document.getElementById('exportToExcel').addEventListener('click', function () {
                    let csvContent = 'Team Name,Idea\n';
                    teamIdeaMapping.forEach(mapping => {
                        csvContent += `${mapping.teamName},${mapping.idea}\n`;
                    });
                    downloadCSV(csvContent, 'team_idea_mapping.csv');
                });
            },
            header: true,
        });
    });
</script>

</body>
</html>
